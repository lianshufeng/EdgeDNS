worker_processes auto;

events {
    worker_connections 2048;
}

http {
    lua_shared_dict certs 20m;

    resolver 61.128.128.68 valid=300s;
    resolver_timeout 2s;

    proxy_cache_path /var/cache/nginx
        levels=1:2
        keys_zone=global_cache:200m
        max_size=10g
        inactive=30d
        use_temp_path=off;

    # ===========================================
    # 1) 用 $uri 判断静态文件（不含 query，永不误判）
    # ===========================================
    map $uri $is_static_ext {
        default 0;

        ~*\.png$        1;
        ~*\.jpg$        1;
        ~*\.jpeg$       1;
        ~*\.gif$        1;
        ~*\.webp$       1;
        ~*\.bmp$        1;
        ~*\.svg$        1;
        ~*\.ico$        1;

        ~*\.css$        1;
        ~*\.js$         1;
        ~*\.mjs$        1;

        ~*\.woff2?$     1;
        ~*\.ttf$        1;
        ~*\.otf$        1;
        ~*\.eot$        1;

        ~*\.json$       1;
        ~*\.xml$        1;
        ~*\.txt$        1;

        ~*\.mp4$        1;
        ~*\.mp3$        1;
        ~*\.ogg$        1;
        ~*\.wav$        1;
        ~*\.webm$       1;

        ~*\.zip$        1;
        ~*\.rar$        1;
        ~*\.7z$         1;
        ~*\.gz$         1;
        ~*\.tar$        1;
    }

    # ===========================================
    # 2) 空字符串 = false（允许缓存）
    # ===========================================
    map $is_static_ext $final_cache_flag {
        1       "";
        default "1";
    }

    # ===========================================
    # 日志
    # ===========================================
    log_format cache_log '$remote_addr - $host [$time_local] '
                         '"$request" $status Cache:$upstream_cache_status';

    access_log /var/log/nginx/cache_access.log cache_log;


    # ===========================================
    # 忽略上游禁止缓存信号（CDN 私有头）
    # ===========================================
    proxy_hide_header X-Cache;
    proxy_hide_header X-Cache-Remote;
    proxy_hide_header X-Swift-CacheTime;
    proxy_hide_header X-Swift-Savetime;
    proxy_hide_header Ali-Swift-Global-Savetime;


    # ===========================================
    # HTTP 80
    # ===========================================
    server {
        listen 80;
        server_name _;

        proxy_cache global_cache;
        proxy_cache_valid 200 301 302 1d;

        proxy_cache_key "$host$uri$is_args$args";

        proxy_no_cache     $final_cache_flag;
        proxy_cache_bypass $final_cache_flag;

        # 忽略上游 Cache-Control 等限制
        proxy_ignore_headers Cache-Control Expires Set-Cookie;
        proxy_hide_header Set-Cookie;

        # 防止首次 304 导致缓存文件无法写入
        proxy_set_header If-Modified-Since "";
        proxy_set_header If-None-Match "";

        add_header X-Cache $upstream_cache_status always;

        location / {
            proxy_set_header Host $host;
            proxy_pass http://$host;
        }
    }

    # ===========================================
    # HTTPS 443
    # ===========================================
    server {
        listen 443 ssl;
        server_name _;

        ssl_certificate     /etc/nginx/ssl/dummy.crt;
        ssl_certificate_key /etc/nginx/ssl/dummy.key;
        ssl_certificate_by_lua_file /usr/local/openresty/lua/generate_cert.lua;

        proxy_cache global_cache;
        proxy_cache_valid 200 301 302 1d;

        proxy_cache_key "$host$uri$is_args$args";

        proxy_no_cache     $final_cache_flag;
        proxy_cache_bypass $final_cache_flag;

        proxy_ignore_headers Cache-Control Expires Set-Cookie;
        proxy_hide_header    Set-Cookie;

        proxy_hide_header X-Cache;
        proxy_hide_header X-Cache-Remote;
        proxy_hide_header X-Swift-CacheTime;
        proxy_hide_header X-Swift-Savetime;
        proxy_hide_header Ali-Swift-Global-Savetime;

        proxy_set_header If-Modified-Since "";
        proxy_set_header If-None-Match "";

        add_header X-Cache $upstream_cache_status always;

        location / {
            proxy_set_header Host $host;
            proxy_pass https://$host;
            proxy_ssl_server_name on;
        }
    }
}
